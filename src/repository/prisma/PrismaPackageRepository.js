// File: repository/prisma/PrismaPackageRepository.jsimport { PackageRepository } from "../interface/PackageRepository.js";import CommonError from "../../errors/CommonError.js";/** * @description Implementasi Repository untuk model 'SigningPackage' menggunakan Prisma. * Mengelola 'SigningPackage', 'PackageDocument', dan 'PackageSignature'. * @extends {PackageRepository} */export class PrismaPackageRepository extends PackageRepository {    /**     * @param {PrismaClient} prisma - Instance Prisma yang di-inject.     */    constructor(prisma) {        super(); // Panggil constructor super()        if (!prisma) {            // Menggunakan CommonError untuk error dependency            throw CommonError.InternalServerError("Prisma Client harus disediakan untuk PrismaPackageRepository.");        }        this.prisma = prisma;    }    /* ====================================================================     * METODE UNTUK SigningPackage (PAKET UTAMA)     * ==================================================================== */    /**     * @description Membuat 'SigningPackage' baru dan 'PackageDocument'     * yang terkait dalam satu transaksi.     * @param {string} userId - ID pemilik paket.     * @param {string} title - Judul paket (opsional).     * @param {string[]} docVersionIds - Array dari ID Versi Dokumen yang akan dimasukkan.     * @returns {Promise<object>} Objek SigningPackage yang baru dibuat.     */    async createPackageWithDocuments(userId, title, docVersionIds) {        try {            return await this.prisma.$transaction(async (tx) => {                // 1. Buat paket utamanya                const newPackage = await tx.signingPackage.create({                    data: {                        userId: userId,                        title: title || "Paket Dokumen Baru",                        status: "draft",                    },                });                // 2. Siapkan data dokumen untuk paket tersebut                const packageDocumentsData = docVersionIds.map((versionId, index) => ({                    packageId: newPackage.id,                    docVersionId: versionId,                    order: index + 1, // Menetapkan urutan 1, 2, 3, ...                }));                // 3. Buat semua record 'PackageDocument'                await tx.packageDocument.createMany({                    data: packageDocumentsData,                });                return newPackage;            });        } catch (error) {            // Menangkap kegagalan transaksi atau error database lainnya            throw CommonError.DatabaseError(`Gagal membuat paket di database: ${error.message}`);        }    }    /**     * @description Menemukan satu SigningPackage berdasarkan ID,     * termasuk detail dokumen di dalamnya.     * @param {string} packageId - ID paket.     * @param {string} userId - ID user (untuk validasi kepemilikan).     * @returns {Promise<object|null>}     */    async findPackageById(packageId, userId) {        try {            const pkg = await this.prisma.signingPackage.findFirst({                where: {                    id: packageId,                    userId: userId, // Memastikan hanya pemilik yang bisa mengambil                },                include: {                    documents: {                        orderBy: { order: "asc" },                        include: {                            docVersion: {                                include: {                                    document: {                                        select: {                                            id: true,                                            title: true                                        }                                    },                                },                            },                        },                    },                },            });            // Sesuai permintaan Anda: Repository akan melempar error jika tidak ditemukan            if (!pkg) {                throw CommonError.NotFound(`Paket tanda tangan dengan ID '${packageId}' tidak ditemukan.`);            }            return pkg;        } catch (error) {            // Jika errornya sudah CommonError, lempar ulang            if (error instanceof CommonError) {                throw error;            }            // Jika tidak, bungkus sebagai error database            throw CommonError.DatabaseError(`Gagal mencari paket: ${error.message}`);        }    }    /**     * @description Memperbarui status sebuah SigningPackage.     * @param {string} packageId - ID paket.     * @param {string} status - Status baru (misal: "completed").     * @returns {Promise<object>}     */    async updatePackageStatus(packageId, status) {        try {            return await this.prisma.signingPackage.update({                where: { id: packageId },                data: { status: status },            });        } catch (error) {            // Tangani jika 'update' gagal (misal: record not found)            if (error.code === 'P2025') { // Kode Prisma untuk "Record not found"                throw CommonError.NotFound(`Paket dengan ID '${packageId}' tidak ditemukan untuk diupdate.`);            }            // Error lain            throw CommonError.DatabaseError(`Gagal update status paket: ${error.message}`);        }    }    /* ====================================================================     * METODE UNTUK PackageSignature (TANDA TANGAN)     * ==================================================================== */    /**     * @description Menyimpan (createMany) array dari data tanda tangan paket.     * @param {Array<object>} signaturesData - Array objek data TTD     * (misal: [{ packageDocumentId, signerId, pageNumber, ... }])     * @returns {Promise<object>} Hasil dari createMany (jumlah TTD yang dibuat).     */    async createPackageSignatures(signaturesData) {        try {            // Kita tidak bisa pakai createMany jika ingin ID-nya kembali            const createdSignatures = [];            for (const data of signaturesData) {                const newSignature = await this.prisma.packageSignature.create({                    data: data,                });                createdSignatures.push(newSignature);            }            return createdSignatures;        } catch (error) {            throw CommonError.DatabaseError(`Gagal menyimpan data tanda tangan paket: ${error.message}`);        }    }}