import CommonError from "../../errors/CommonError.js";export class PrismaGroupSignatureRepository {    constructor(prisma) {        this.prisma = prisma;    }    /**     * [CREATE] Group Signature     * Menggantikan: createGroupSignature     */    async create(data) {        const { id, documentVersionId, userId, ...rest } = data;        return this.prisma.signatureGroup.create({            data: {                id: id, // Bisa undefined jika auto-generated                documentVersion: { connect: { id: documentVersionId } },                signer: { connect: { id: userId } },                pageNumber: rest.pageNumber,                positionX: parseFloat(rest.positionX),                positionY: parseFloat(rest.positionY),                width: parseFloat(rest.width || 0),                height: parseFloat(rest.height || 0),                signatureImageUrl: rest.signatureImageUrl || "",                method: rest.method || "canvas",                status: rest.status || "draft",            },            include: {                signer: { select: { id: true, name: true, email: true } },            },        });    }    /**     * [READ] Find One by ID     * Menggantikan: findGroupSignatureById     */    async findById(id) {        return this.prisma.signatureGroup.findUnique({            where: { id },            include: {                signer: true,                documentVersion: { include: { document: true } },            },        });    }    /**     * [READ] Find Specific User's Signature in a Version     * Menggantikan: findGroupSignatureBySigner     * Berguna untuk cek apakah user ini sudah punya draft/ttd di versi ini.     */    async findBySignerAndVersion(userId, documentVersionId) {        return this.prisma.signatureGroup.findFirst({            where: { signerId: userId, documentVersionId: documentVersionId },        });    }    /**     * [READ] Get All Signatures for a Version     * Menggantikan: findGroupSignaturesByVersionId     * Berguna saat Finalisasi (Burn PDF).     */    async findAllByVersionId(documentVersionId) {        return this.prisma.signatureGroup.findMany({            where: { documentVersionId: documentVersionId },            orderBy: { signedAt: "asc" },        });    }    /**     * [UPDATE]     * Menggantikan: updateGroupSignature     */    async update(id, data) {        try {            return await this.prisma.signatureGroup.update({                where: { id },                data: {                    positionX: data.positionX !== undefined ? parseFloat(data.positionX) : undefined,                    positionY: data.positionY !== undefined ? parseFloat(data.positionY) : undefined,                    width: data.width !== undefined ? parseFloat(data.width) : undefined,                    height: data.height !== undefined ? parseFloat(data.height) : undefined,                    pageNumber: data.pageNumber,                    signatureImageUrl: data.signatureImageUrl,                    method: data.method,                    status: data.status,                },                include: {                    signer: { select: { id: true, name: true, email: true } },                },            });        } catch (error) {            if (error.code === "P2025") return null;            throw error;        }    }    /**     * [DELETE] Single     * Menggantikan: deleteGroupSignature     */    async delete(id) {        return this.prisma.signatureGroup.deleteMany({            where: { id },        });    }    /**     * [DELETE] Many Drafts (Cleanup)     * Menggantikan: deleteManyDrafts     */    async deleteDrafts(documentId, userId) {        return this.prisma.signatureGroup.deleteMany({            where: {                signerId: userId,                status: "draft",                documentVersion: {                    documentId: documentId,                },            },        });    }    /**     * [BARU - REQUIRED FOR ROLLBACK]     * Menghapus signature Group berdasarkan Version.     * Jika userId null -> Hapus semua (Rollback).     */    async deleteBySignerAndVersion(userId, documentVersionId) {        const whereCondition = {            documentVersionId: documentVersionId,        };        if (userId) {            whereCondition.signerId = userId;        }        return this.prisma.signatureGroup.deleteMany({            where: whereCondition,        });    }}