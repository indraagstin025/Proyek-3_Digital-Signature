import multer from 'multer';// 1. Konfigurasi Storage (Wajib MemoryStorage karena Service butuh Buffer)const storage = multer.memoryStorage();// 2. Batasan Ukuran File// SANGAT DISARANKAN: Set MAX_FILE_SIZE_MB di Railway menjadi 10 atau 15.const MAX_SIZE_MB = parseInt(process.env.MAX_FILE_SIZE_MB) || 10;const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;/** * ========================================== * FILTER LOGIC * ========================================== */const documentFileFilter = (req, file, cb) => {    const allowedMimeTypes = [        'application/pdf',        'application/msword', // .doc        'application/vnd.openxmlformats-officedocument.wordprocessingml.document' // .docx    ];    if (allowedMimeTypes.includes(file.mimetype)) {        cb(null, true);    } else {        const err = new Error('Format file tidak didukung. Hanya PDF dan Word yang diizinkan.');        err.code = 'INVALID_FILE_TYPE';        cb(err, false);    }};const imageFileFilter = (req, file, cb) => {    if (file.mimetype.startsWith('image/')) {        cb(null, true);    } else {        const err = new Error('Format file salah. Harap unggah file Gambar (JPG/PNG).');        err.code = 'INVALID_FILE_TYPE';        cb(err, false);    }};const pdfFileFilter = (req, file, cb) => {    if (file.mimetype === 'application/pdf') {        cb(null, true);    } else {        const err = new Error('Format file salah. Hanya file PDF yang diizinkan untuk proses ini.');        err.code = 'INVALID_FILE_TYPE';        cb(err, false);    }};/** * Helper: Membuat Instance Multer Asli */const createMulterRaw = (filterFn) => {    return multer({        storage: storage,        limits: {            fileSize: MAX_SIZE_BYTES, // Limit di level Multer        },        fileFilter: filterFn,    });};/** * ========================================== * MAGIC WRAPPER (Solusi Error .single is not a function) * ========================================== * Fungsi ini membungkus Multer agar kita bisa menangkap error * dan mengembalikan JSON, tapi tetap bisa dipanggil dengan .single() di routes. */const withErrorHandling = (multerInstance) => {    return {        // Kita buat ulang fungsi .single() agar support custom error handling        single: (fieldName) => (req, res, next) => {            const upload = multerInstance.single(fieldName);            upload(req, res, (err) => {                if (err instanceof multer.MulterError) {                    // Error spesifik Multer (misal: File Too Large)                    if (err.code === 'LIMIT_FILE_SIZE') {                        return res.status(400).json({                            status: 'fail',                            message: `Ukuran file terlalu besar. Maksimum ${MAX_SIZE_MB}MB.`                        });                    }                    // Error Multer lainnya (misal: Field name salah)                    return res.status(400).json({                        status: 'fail',                        message: `Upload Error: ${err.message}`                    });                } else if (err) {                    // Error dari fileFilter (Salah tipe file)                    return res.status(400).json({                        status: 'fail',                        message: err.message                    });                }                // Jika sukses, lanjut ke Controller                next();            });        },        // Jika nanti butuh .array() atau .fields(), tinggal tambahkan di sini        array: (fieldName, maxCount) => (req, res, next) => {            const upload = multerInstance.array(fieldName, maxCount);            upload(req, res, (err) => {                if (err) return res.status(400).json({ status: 'fail', message: err.message });                next();            });        }    };};/** * ========================================== * EXPORTS (Middleware Siap Pakai) * ========================================== */// 1. Buat Instance Raw duluconst uploadDocRaw = createMulterRaw(documentFileFilter);const uploadImgRaw = createMulterRaw(imageFileFilter);const uploadPdfRaw = createMulterRaw(pdfFileFilter);// 2. Export versi "Safe" yang sudah dibungkus error handling// Ini akan punya method .single() jadi routes Anda TIDAK PERLU DIUBAH.export const uploadDocument = withErrorHandling(uploadDocRaw);export const uploadImage = withErrorHandling(uploadImgRaw);export const uploadPdfForVerification = withErrorHandling(uploadPdfRaw);