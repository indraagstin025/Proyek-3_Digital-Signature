import multer from 'multer';// 1. Konfigurasi Storage (Wajib MemoryStorage karena Service butuh Buffer)const storage = multer.memoryStorage();// 2. Batasan Ukuran File GLOBAL// [PENTING] Set ini ke angka MAKSIMAL yang diizinkan untuk PREMIUM (misal 50MB atau 60MB).// Jika diset 10MB, User Premium akan tertolak di sini sebelum masuk Service.const MAX_SIZE_MB = parseInt(process.env.MAX_FILE_SIZE_MB) || 60;const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;/** * ========================================== * FILTER LOGIC * ========================================== */const documentFileFilter = (req, file, cb) => {    const allowedMimeTypes = [        'application/pdf',        'application/msword', // .doc        'application/vnd.openxmlformats-officedocument.wordprocessingml.document' // .docx    ];    if (allowedMimeTypes.includes(file.mimetype)) {        cb(null, true);    } else {        const err = new Error('Format file tidak didukung. Hanya PDF dan Word yang diizinkan.');        err.code = 'INVALID_FILE_TYPE';        cb(err, false);    }};const imageFileFilter = (req, file, cb) => {    if (file.mimetype.startsWith('image/')) {        cb(null, true);    } else {        const err = new Error('Format file salah. Harap unggah file Gambar (JPG/PNG).');        err.code = 'INVALID_FILE_TYPE';        cb(err, false);    }};const pdfFileFilter = (req, file, cb) => {    if (file.mimetype === 'application/pdf') {        cb(null, true);    } else {        const err = new Error('Format file salah. Hanya file PDF yang diizinkan untuk proses ini.');        err.code = 'INVALID_FILE_TYPE';        cb(err, false);    }};/** * Helper: Membuat Instance Multer Asli */const createMulterRaw = (filterFn) => {    return multer({        storage: storage,        limits: {            fileSize: MAX_SIZE_BYTES, // Limit Fisik Server (60MB)        },        fileFilter: filterFn,    });};/** * ========================================== * MAGIC WRAPPER (Solusi Error .single is not a function) * ========================================== */const withErrorHandling = (multerInstance) => {    return {        single: (fieldName) => (req, res, next) => {            const upload = multerInstance.single(fieldName);            upload(req, res, (err) => {                if (err instanceof multer.MulterError) {                    if (err.code === 'LIMIT_FILE_SIZE') {                        // Error ini hanya muncul jika file > 60MB (Limit Server)                        return res.status(400).json({                            status: 'fail',                            message: `Ukuran file terlalu besar. Batas maksimum server adalah ${MAX_SIZE_MB}MB.`                        });                    }                    return res.status(400).json({                        status: 'fail',                        message: `Upload Error: ${err.message}`                    });                } else if (err) {                    return res.status(400).json({                        status: 'fail',                        message: err.message                    });                }                next();            });        },        array: (fieldName, maxCount) => (req, res, next) => {            const upload = multerInstance.array(fieldName, maxCount);            upload(req, res, (err) => {                if (err) return res.status(400).json({ status: 'fail', message: err.message });                next();            });        }    };};/** * ========================================== * EXPORTS (Middleware Siap Pakai) * ========================================== */const uploadDocRaw = createMulterRaw(documentFileFilter);const uploadImgRaw = createMulterRaw(imageFileFilter);const uploadPdfRaw = createMulterRaw(pdfFileFilter);export const uploadDocument = withErrorHandling(uploadDocRaw);export const uploadImage = withErrorHandling(uploadImgRaw);export const uploadPdfForVerification = withErrorHandling(uploadPdfRaw);