import multer from 'multer';/** * Konfigurasi Penyimpanan: * Menggunakan MemoryStorage agar file tersedia sebagai Buffer di `req.file.buffer`. * Ini sangat efisien untuk langsung di-upload ke Cloud Storage (Supabase/S3) tanpa simpan ke disk server dulu. */const storage = multer.memoryStorage();// Mengambil batas ukuran dari .env atau default 5MBconst MAX_SIZE_MB = process.env.MAX_FILE_SIZE_MB || 5;const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;/** * Filter untuk Dokumen (PDF & Word). * Catatan: Jika Anda mengizinkan Word, pastikan di backend ada konversi ke PDF * sebelum menggunakan library signature (karena pdf-lib biasanya hanya baca PDF). */const documentFileFilter = (req, file, cb) => {    const allowedMimeTypes = [        'application/pdf',        'application/msword', // .doc        'application/vnd.openxmlformats-officedocument.wordprocessingml.document' // .docx    ];    if (allowedMimeTypes.includes(file.mimetype)) {        cb(null, true);    } else {        // Error standar JavaScript, akan ditangkap oleh Global Error Handler        cb(new Error('Format file tidak didukung. Harap unggah PDF atau Word.'), false);    }};/** * Filter Khusus PDF (Untuk verifikasi atau tanda tangan strict). */const pdfFileFilter = (req, file, cb) => {    if (file.mimetype === 'application/pdf') {        cb(null, true);    } else {        cb(new Error('Format file salah. Hanya file PDF yang diizinkan untuk proses ini.'), false);    }};/** * Filter untuk Gambar (Tanda Tangan/Foto Profil). */const imageFileFilter = (req, file, cb) => {    // Mengecek apakah mimetype diawali dengan 'image/' (image/jpeg, image/png, dll)    if (file.mimetype.startsWith('image/')) {        cb(null, true);    } else {        cb(new Error('Format file salah. Harap unggah file Gambar (JPG/PNG).'), false);    }};/** * Helper function untuk membuat instance multer agar kode lebih rapi (DRY). * @param {Function} filterFn - Fungsi filter yang digunakan. */const createMulterInstance = (filterFn) => {    return multer({        storage: storage,        limits: {            fileSize: MAX_SIZE_BYTES, // Batas ukuran dinamis        },        fileFilter: filterFn,    });};// --- EXPORTS ---/** * Middleware upload untuk dokumen utama (Mendukung PDF & Word). * Field name di frontend form-data harus sesuai (misal: 'file'). */export const uploadDocument = createMulterInstance(documentFileFilter);/** * Middleware upload untuk gambar (Foto Profil / Scan Tanda Tangan). */export const uploadImage = createMulterInstance(imageFileFilter);/** * Middleware upload khusus PDF (misal: Verifikasi Dokumen). */export const uploadPdfForVerification = createMulterInstance(pdfFileFilter);