import multer from 'multer';// 1. Konfigurasi Storage (Wajib MemoryStorage karena Service butuh Buffer)const storage = multer.memoryStorage();// 2. Batasan Ukuran File// SANGAT DISARANKAN: Set MAX_FILE_SIZE_MB di Railway menjadi 10 atau maksimal 20.// Jangan set 50MB atau 100MB di RAM 512MB, aplikasi pasti akan sering restart (OOM).const MAX_SIZE_MB = parseInt(process.env.MAX_FILE_SIZE_MB) || 10;const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;/** * Filter Validasi Tipe File yang Diizinkan */const documentFileFilter = (req, file, cb) => {    const allowedMimeTypes = [        'application/pdf',        'application/msword', // .doc        'application/vnd.openxmlformats-officedocument.wordprocessingml.document' // .docx    ];    if (allowedMimeTypes.includes(file.mimetype)) {        cb(null, true);    } else {        // Buat error custom agar bisa ditangkap controller        const err = new Error('Format file tidak didukung. Hanya PDF dan Word yang diizinkan.');        err.code = 'INVALID_FILE_TYPE';        cb(err, false);    }};const imageFileFilter = (req, file, cb) => {    if (file.mimetype.startsWith('image/')) {        cb(null, true);    } else {        const err = new Error('Format file salah. Harap unggah file Gambar (JPG/PNG).');        err.code = 'INVALID_FILE_TYPE';        cb(err, false);    }};/** * Wrapper Multer Instance */const createMulterInstance = (filterFn) => {    return multer({        storage: storage,        limits: {            fileSize: MAX_SIZE_BYTES, // Wajib ada untuk mencegah user upload file 1GB dan bikin server hang        },        fileFilter: filterFn,    });};// --- EXPORTS DENGAN ERROR HANDLING ---const uploadDocRaw = createMulterInstance(documentFileFilter).single('file');const uploadImgRaw = createMulterInstance(imageFileFilter).single('file'); // Sesuaikan field name jika perlu/** * Middleware Wrapper untuk Menangani Error Multer dengan Elegan * Ini mencegah respons HTML jelek jika file terlalu besar. */export const uploadDocument = (req, res, next) => {    uploadDocRaw(req, res, (err) => {        if (err instanceof multer.MulterError) {            // Error spesifik Multer (misal: File Too Large)            if (err.code === 'LIMIT_FILE_SIZE') {                return res.status(400).json({                    status: 'fail',                    message: `Ukuran file terlalu besar. Maksimum ${MAX_SIZE_MB}MB.`                });            }            return res.status(400).json({ status: 'fail', message: err.message });        } else if (err) {            // Error dari fileFilter            return res.status(400).json({ status: 'fail', message: err.message });        }        // Jika sukses, lanjut ke Controller        next();    });};export const uploadImage = (req, res, next) => {    uploadImgRaw(req, res, (err) => {        if (err instanceof multer.MulterError) {            if (err.code === 'LIMIT_FILE_SIZE') {                return res.status(400).json({                    status: 'fail',                    message: `Ukuran gambar terlalu besar. Maksimum ${MAX_SIZE_MB}MB.`                });            }            return res.status(400).json({ status: 'fail', message: err.message });        } else if (err) {            return res.status(400).json({ status: 'fail', message: err.message });        }        next();    });};