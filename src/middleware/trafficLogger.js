import { PrismaClient } from "@prisma/client";const prisma = new PrismaClient();export const trafficLogger = async (req, res, next) => {    // Jangan catat request ke file statis atau OPTIONS    if (req.method === "OPTIONS" || req.url.includes("/public") || req.url.includes("favicon")) {        return next();    }    const start = Date.now();    // Hook ke event 'finish' response (saat response dikirim ke user)    res.on("finish", async () => {        const duration = Date.now() - start;        try {            // Coba ambil User ID jika ada di req.user (dari middleware auth sebelumnya)            const userId = req.user ? req.user.id : null;            await prisma.apiRequestLog.create({                data: {                    method: req.method,                    endpoint: req.originalUrl || req.url,                    statusCode: res.statusCode,                    duration: duration,                    // Ambil IP (support proxy/cloud hosting)                    ipAddress: req.headers["x-forwarded-for"] || req.socket.remoteAddress || "0.0.0.0",                    userAgent: req.headers["user-agent"] || "Unknown",                    userId: userId,                },            });        } catch (error) {            // Error logging jangan sampai bikin aplikasi crash            console.error("[TrafficLogger] Gagal mencatat log:", error.message);        }    });    next();};