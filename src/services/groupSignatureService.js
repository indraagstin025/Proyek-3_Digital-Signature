import CommonError from "../errors/CommonError.js";import crypto from "crypto";export class GroupSignatureService {    constructor(        groupSignatureRepository,        groupDocumentSignerRepository,        documentRepository,        versionRepository,        groupMemberRepository,        pdfService,        auditService    ) {        this.groupSignatureRepository = groupSignatureRepository; // Gunakan Repo Khusus Group        this.groupDocumentSignerRepository = groupDocumentSignerRepository;        this.documentRepository = documentRepository;        this.versionRepository = versionRepository;        this.groupMemberRepository = groupMemberRepository;        this.pdfService = pdfService;        this.auditService = auditService;    }    /**     * [DRAFT] Menyimpan Draft Tanda Tangan Group (Auto-save Drag & Drop).     * Logika UPSERT (Update jika ID ada, Create jika baru).     */    async saveDraft(userId, documentId, signatureData) {        const document = await this.documentRepository.findById(documentId, userId);        if (!document) throw CommonError.NotFound(documentId);        const payload = {            id: signatureData.id, // ID dari Frontend (UUID)            userId: userId,            documentVersionId: document.currentVersionId,            status: "draft",            method: signatureData.method || "canvas",            signatureImageUrl: signatureData.signatureImageUrl,            positionX: signatureData.positionX,            positionY: signatureData.positionY,            pageNumber: signatureData.pageNumber,            width: signatureData.width || 0,            height: signatureData.height || 0,        };        console.log("[GroupService] Saving Draft:", payload.id);        // Cek apakah draft dengan ID ini sudah ada?        const existing = await this.groupSignatureRepository.findById(payload.id);        if (existing) {            // Jika ada, update posisinya saja            return await this.groupSignatureRepository.update(existing.id, payload);        } else {            // Jika belum, create baru            return await this.groupSignatureRepository.create(payload);        }    }    /**     * [UPDATE POSITION] Update posisi draft group (Drag/Resize).     */    async updateDraftPosition(signatureId, positionData) {        const updatePayload = {            positionX: positionData.positionX,            positionY: positionData.positionY,            width: positionData.width,            height: positionData.height,            pageNumber: positionData.pageNumber,        };        const updated = await this.groupSignatureRepository.update(signatureId, updatePayload);        if (!updated) {            // Opsional: Throw error 404 kalau barangnya beneran ga ada            // Tapi biasanya Frontend drag and drop lebih suka silent fail/retry            return null;        }        return updated;    }    /**     * [DELETE] Hapus Draft Group.     */    async deleteDraft(signatureId) {        const result = await this.groupSignatureRepository.delete(signatureId);        return result && result.count > 0;    }    /**     * [USER ACTION] Menandatangani Dokumen (Tanda Tangan Individu dalam Grup).     * Sebenarnya hanya mengubah status Draft -> Final.     */    async signDocument(userId, documentId, signatureData, auditData, req = null) {        // 1. Cek Hak Akses        const signerRequest = await this.groupDocumentSignerRepository.findPendingByUserAndDoc(userId, documentId);        if (!signerRequest) {            throw CommonError.BadRequest("Anda tidak memiliki akses atau sudah tanda tangan.");        }        const document = await this.documentRepository.findById(documentId, userId);        const currentVersion = document.currentVersion;        // 2. Cek apakah user sudah punya draft?        // Gunakan findBySignerAndVersion yang baru kita buat di Repo Group        const existingSignature = await this.groupSignatureRepository.findBySignerAndVersion(userId, currentVersion.id);        let finalSignature;        const payload = {            ...signatureData,            userId: userId,            documentVersionId: currentVersion.id,            status: "final", // UBAH KE FINAL            ipAddress: auditData.ipAddress,            userAgent: auditData.userAgent        };        if (existingSignature) {            finalSignature = await this.groupSignatureRepository.update(existingSignature.id, payload);        } else {            finalSignature = await this.groupSignatureRepository.create(payload);        }        // 3. Update Status Checklist Signer (Pending -> Signed)        await this.groupDocumentSignerRepository.updateStatusToSigned(documentId, userId, finalSignature.id);        // 4. Audit Log        if (this.auditService) {            await this.auditService.log("SIGN_DOCUMENT_GROUP", userId, documentId, `User menandatangani dokumen grup: ${document.title}`, req);        }        // 5. Cek Sisa Signer        const pendingCount = await this.groupDocumentSignerRepository.countPendingSigners(documentId);        return {            ...finalSignature,            message: pendingCount === 0 ? "Tanda tangan berhasil. Menunggu finalisasi Admin." : "Tanda tangan disimpan.",            isComplete: false,            readyToFinalize: pendingCount === 0,            remainingSigners: pendingCount,        };    }    /**     * [ADMIN ACTION] Finalisasi Dokumen Grup.     * Menggabungkan semua tanda tangan anggota (Canvas) menjadi 1 PDF (Burn).     */    async finalizeGroupDocument(groupId, documentId, adminId) {        // 1. Validasi Admin        const member = await this.groupMemberRepository.findByGroupAndUser(groupId, adminId);        if (!member || member.role !== "admin_group") {            throw CommonError.Forbidden("Hanya admin grup yang dapat memfinalisasi dokumen.");        }        // 2. Cek Kelengkapan        const pendingCount = await this.groupDocumentSignerRepository.countPendingSigners(documentId);        if (pendingCount > 0) {            throw CommonError.BadRequest(`Masih ada ${pendingCount} anggota yang belum tanda tangan.`);        }        const document = await this.documentRepository.findById(documentId, adminId);        if (document.status === "completed") {            throw CommonError.BadRequest("Dokumen sudah final.");        }        // 3. Ambil SEMUA Signature Group Final        const currentVersion = document.currentVersion;        // Gunakan findAllByVersionId dari Repo Group        const allSignatures = await this.groupSignatureRepository.findAllByVersionId(currentVersion.id);        if (allSignatures.length === 0) {            throw CommonError.BadRequest("Tidak ada tanda tangan untuk difinalisasi.");        }        // 4. Siapkan Payload untuk PDFService        const signaturesPayload = allSignatures.map((sig) => ({            signatureImageUrl: sig.signatureImageUrl,            pageNumber: sig.pageNumber,            positionX: sig.positionX,            positionY: sig.positionY,            width: sig.width,            height: sig.height,        }));        // 5. PANGGIL PDF SERVICE (Burn & Crypto Sign)        // Group: biasanya 1 QR code untuk dokumen final.        const { signedFileBuffer, publicUrl } = await this.pdfService.generateSignedPdf(            currentVersion.id,            signaturesPayload,            { displayQrCode: false } // QR Code opsional        );        // 6. Buat Versi Final Baru & Update Dokumen        const newHash = crypto.createHash("sha256").update(signedFileBuffer).digest("hex");        const newVersion = await this.versionRepository.create({            documentId: documentId,            userId: adminId,            url: publicUrl,            hash: newHash,            signedFileHash: newHash,        });        await this.documentRepository.update(documentId, {            currentVersionId: newVersion.id,            status: "completed",            signedFileUrl: publicUrl,        });        return { message: "Dokumen berhasil difinalisasi.", url: publicUrl };    }}