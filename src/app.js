import express from 'express';import 'dotenv/config';import cors from 'cors';import morgan from 'morgan';import logger from './utils/logger.js';// --- IMPORTS ---import { PrismaClient } from '@prisma/client';import { AuthService } from './services/authService.js';import { UserService } from './services/userService.js';import { DocumentService } from './services/documentService.js';import { SignatureService } from "./services/signatureService.js";import { PDFService } from "./services/pdfService.js";import PrismaUserRepository from "./repository/prisma/PrismaUserRepository.js";import { PrismaDocumentRepository } from './repository/prisma/PrismaDocumentRepository.js';import { PrismaVersionRepository } from './repository/prisma/PrismaVersionRepository.js';import { PrismaSignatureRepository } from "./repository/prisma/PrismaSignatureRepository.js";import SupabaseAuthRepository from './repository/supabase/SupabaseAuthRepository.js';import SupabaseFileStorage from "./repository/supabase/SupabaseFileStorage.js";import { createAuthController } from './controllers/authController.js';import { createUserController } from './controllers/userController.js';import { createAdminController } from './controllers/adminController.js';import { createDocumentController } from './controllers/documentController.js';import { createSignatureController } from "./controllers/signatureController.js";import createAuthRoutes from './routes/authRoutes.js';import createUserRoutes from './routes/userRoutes.js';import createDocumentRoutes from './routes/documentRoutes.js';import createSignatureRoutes from './routes/signatureRoutes.js';const app = express();// --- MIDDLEWARE (Tidak ada perubahan) ---const stream = {    write: (message) => logger.http(message.trim()),};const morganMiddleware = morgan(    ":method :url :status :res[content-length] - :response-time ms",    { stream });app.use(morganMiddleware);app.use(express.json());app.use(cors({    origin: 'http://localhost:5173',}));app.get('/', (req, res) => {    res.json({        message: '✅ API sudah berjalan',        status: 'success',        timestamp: new Date().toISOString()    });});// --- INISIALISASI ---const prisma = new PrismaClient();// 1. Inisialisasi Repositoriconst authRepository = new SupabaseAuthRepository();const userRepository = new PrismaUserRepository(prisma);const documentRepository = new PrismaDocumentRepository(prisma);const versionRepository = new PrismaVersionRepository(prisma);const signatureRepository = new PrismaSignatureRepository(prisma);// ✅ PERBAIKAN 1: `fileStorage` harus diinisialisasi bersama repository lain, SEBELUM serviceconst fileStorage = new SupabaseFileStorage();console.log('--- DEBUGGING fileStorage OBJECT ---');console.log('Isi dari fileStorage:', fileStorage);console.log('Apakah metode uploadDocument ada?:', typeof fileStorage.uploadDocument);console.log('--- END DEBUGGING ---');// 2. Inisialisasi Layananconst authService = new AuthService(authRepository);const userService = new UserService(userRepository, fileStorage);const pdfService = new PDFService(versionRepository, signatureRepository, fileStorage);// ✅ PERBAIKAN 2: `SignatureService` versi baru hanya butuh `signatureRepository`const signatureService = new SignatureService(signatureRepository);const documentService = new DocumentService(    documentRepository,    versionRepository,    signatureRepository,    fileStorage,    pdfService);// 3. Inisialisasi Pengontrolconst authController = createAuthController(authService);const userController = createUserController(userService);const adminController = createAdminController(userService);const documentController = createDocumentController(documentService);// ✅ PERBAIKAN 3: `SignatureController` butuh `documentService` dan `signatureService`const signatureController = createSignatureController(documentService, signatureService);// 4. Inisialisasi Ruteapp.use('/api/auth', createAuthRoutes(authController));app.use('/api/users', createUserRoutes(userController, adminController));app.use('/api/documents', createDocumentRoutes(documentController));app.use('/api/signatures', createSignatureRoutes(signatureController));const port = process.env.PORT || 3000;app.listen(port, () => {    console.log(`✅ Server berjalan di http://localhost:${port}`);});