import { parse } from 'cookie';import prisma from '../config/prismaClient.js';import { supabase } from '../config/supabaseClient.js'; // Client untuk Authimport { createClient } from 'redis';import { createAdapter } from '@socket.io/redis-adapter';// âœ… [BARU] Import Bucket Name dari config terpusatimport { supabaseBucket } from '../config/supabaseAdmin.js';// Ambil URL Project dari Env (Masih diperlukan untuk merakit URL string)const REDIS_URL = process.env.REDIS_URL;const SUPABASE_URL = process.env.SUPABASE_URL;const SUPABASE_BUCKET = "avatar";/** * Helper: Mengubah path relatif menjadi Full URL Public Supabase. * Menggunakan 'supabaseBucket' yang diimport dari config/supabaseAdmin.js */const formatAvatarUrl = (path) => {    // 1. Jika path kosong/null, return null    if (!path) return null;    // 2. Jika path sudah berupa URL lengkap (misal login via Google), kembalikan langsung    if (path.startsWith("http")) return path;    // 3. Validasi Env & Config    if (!SUPABASE_URL || !supabaseBucket) {        console.warn("âš ï¸ SUPABASE_URL atau supabaseBucket belum terkonfigurasi dengan benar.");        // Fallback: kembalikan path aslinya daripada error        return path;    }    // 4. Rakit URL    // Format: [PROJECT_URL]/storage/v1/object/public/[NAMA_BUCKET]/[PATH_FILE]    return `${SUPABASE_URL}/storage/v1/object/public/${SUPABASE_BUCKET}/${path}`;};export const initSocket = async (io) => {    // --- 1. SETUP REDIS ADAPTER ---    if (REDIS_URL) {        console.log('ğŸš€ Mendeteksi REDIS_URL, mencoba koneksi Redis...');        const pubClient = createClient({ url: REDIS_URL });        const subClient = pubClient.duplicate();        pubClient.on('error', (err) => console.error('âŒ Redis Error:', err));        subClient.on('error', (err) => console.error('âŒ Redis Error:', err));        try {            await Promise.all([pubClient.connect(), subClient.connect()]);            io.adapter(createAdapter(pubClient, subClient));            console.log('âœ… Redis Adapter Terhubung (Mode Cluster Siap)');        } catch (error) {            console.error('âš ï¸ Gagal connect Redis, fallback ke Memory:', error);        }    } else {        console.log('â˜• Mode Development: Menggunakan RAM Laptop (Tanpa Redis)');    }    // --- 2. MIDDLEWARE AUTH ---    io.use(async (socket, next) => {        try {            const cookieHeader = socket.request.headers.cookie;            if (!cookieHeader) return next(new Error("Authentication error: No cookies found."));            const cookies = parse(cookieHeader);            const accessToken = cookies['sb-access-token'];            if (!accessToken) return next(new Error("Authentication error: Access token missing."));            // A. Validasi Token ke Supabase Auth (Client Standard)            const { data, error } = await supabase.auth.getUser(accessToken);            if (error || !data.user) return next(new Error("Authentication error: Invalid or expired token."));            // B. Ambil Data User dari DB Lokal (Prisma)            const localUser = await prisma.user.findUnique({                where: { id: data.user.id },                select: {                    id: true,                    name: true,                    email: true,                    isSuperAdmin: true,                    profilePictureUrl: true, // Ambil path relatif dari DB                },            });            if (!localUser) return next(new Error("Authentication error: User not found in local DB."));            // ğŸ”¥ [LANGKAH KUNCI] Mutasi path relatif menjadi Full URL Public            // Menggunakan helper yang sudah terhubung dengan supabaseAdmin config            localUser.profilePictureUrl = formatAvatarUrl(localUser.profilePictureUrl);            // Simpan user object ke socket session            socket.user = localUser;            socket.data.user = localUser;            next();        } catch (err) {            console.error("[Socket Auth] Internal Error:", err.message);            return next(new Error("Authentication error: Internal Server Error."));        }    });    // --- 3. EVENT HANDLERS ---    io.on("connection", (socket) => {        // console.log(`ğŸŸ¢ User Connected: ${socket.user.name}`);        // A. EVENT JOIN ROOM        socket.on("join_room", async (documentId) => {            socket.join(documentId);            // 1. Beri tahu user LAIN (Kirim Full URL)            socket.to(documentId).emit("user_joined", {                userId: socket.user.id,                userName: socket.user.name,                profilePictureUrl: socket.user.profilePictureUrl,                joinedAt: new Date()            });            // 2. Beri tahu user BARU tentang user LAMA            try {                const sockets = await io.in(documentId).fetchSockets();                const existingUsers = sockets                    .map(s => {                        const u = s.data.user || s.user;                        if (!u) return null;                        return {                            userId: u.id,                            userName: u.name,                            profilePictureUrl: u.profilePictureUrl // Sudah Full URL                        };                    })                    .filter(u => u && u.userId && String(u.userId) !== String(socket.user.id));                // Deduplikasi User                const uniqueUsers = [];                const seenIds = new Set();                for (const u of existingUsers) {                    if (!seenIds.has(u.userId)) {                        seenIds.add(u.userId);                        uniqueUsers.push(u);                    }                }                socket.emit("current_room_users", uniqueUsers);            } catch (error) {                console.error("Gagal fetch sockets:", error);            }        });        // B. EVENT LAINNYA (Sama seperti sebelumnya)        socket.on("drag_signature", (data) => {            socket.to(data.documentId).emit("update_signature_position", data);        });        socket.on("leave_room", (documentId) => {            socket.leave(documentId);            socket.to(documentId).emit("user_left", { userId: socket.user.id });        });        socket.on("trigger_reload", (documentId) => {            socket.to(documentId).emit("refetch_data");        });        socket.on("add_signature_live", (data) => {            socket.to(data.documentId).emit("add_signature_live", data.signature);        });        socket.on("remove_signature_live", (data) => {            socket.to(data.documentId).emit("remove_signature_live", data.signatureId);        });        socket.on("cursor_move", (data) => {            const cursorData = {                ...data,                userId: socket.user.id,                userName: socket.user.name,            };            socket.to(data.documentId).emit("cursor_move", cursorData);        });        socket.on("join_group_room", async (groupId) => {            try {                const gId = parseInt(groupId);                const isMember = await prisma.groupMember.findFirst({                    where: { groupId: gId, userId: socket.user.id }                });                if (isMember) {                    socket.join(`group_${gId}`);                }            } catch (error) {                console.error("Error joining group room:", error);            }        });        socket.on("leave_group_room", (groupId) => {            socket.leave(`group_${groupId}`);        });        socket.on("disconnect", () => {            // Cleanup jika perlu        });    });};