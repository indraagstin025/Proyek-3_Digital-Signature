import asyncHandler from "../utils/asyncHandler.js";import CommonError from "../errors/CommonError.js";/** * Membuat objek controller untuk fitur Paket Tanda Tangan (Signing Package). * * @param {import('../services/PackageService.js').PackageService} packageService - Instance dari PackageService. * @returns {object} Kumpulan fungsi handler untuk paket dokumen. */export const createPackageController = (packageService) => {    if (!packageService) {        throw new Error("createPackageController: 'packageService' tidak disediakan.");    }    return {        /**         * @route   POST /api/packages         * @desc    Membuat paket (amplop) baru dari beberapa dokumen.         */        createPackage: asyncHandler(async (req, res, next) => {            const userId = req.user?.id;            const { documentIds, title } = req.body;            if (!documentIds || !Array.isArray(documentIds) || documentIds.length === 0) {                throw CommonError.BadRequest("Array 'documentIds' (berisi ID dokumen) wajib diisi.");            }            const newPackage = await packageService.createPackage(userId, title, documentIds);            return res.status(201).json({                status: "success",                message: "Paket berhasil dibuat.",                data: newPackage,            });        }),        /**         * @route   GET /api/packages/:packageId         * @desc    Mengambil detail paket, termasuk daftar dokumen di dalamnya.         */        getPackageDetails: asyncHandler(async (req, res, next) => {            const userId = req.user?.id;            const { packageId } = req.params;            const packageDetails = await packageService.getPackageDetails(packageId, userId);            return res.status(200).json({                status: "success",                data: packageDetails,            });        }),        /**         * @route   POST /api/packages/:packageId/sign         * @desc    Menyelesaikan & menandatangani semua dokumen dalam paket (Wizard).         */        signPackage: asyncHandler(async (req, res, next) => {            const userId = req.user?.id;            const { packageId } = req.params;            const { signatures } = req.body;            if (!signatures || !Array.isArray(signatures) || signatures.length === 0) {                throw CommonError.BadRequest("Array 'signatures' (berisi data TTD) wajib diisi.");            }            // --- UPDATE: MENANGKAP IP ADDRESS PENGGUNA ---            const getRealIpAddress = (req) => {                const forwardedFor = req.headers['x-forwarded-for'];                if (forwardedFor && typeof forwardedFor === 'string') {                    return forwardedFor.split(',')[0].trim();                }                return req.ip || req.connection.remoteAddress;            };            const userIpAddress = getRealIpAddress(req);            const result = await packageService.signPackage(packageId, userId, signatures, userIpAddress);            return res.status(200).json({                status: "success",                message: "Paket berhasil ditandatangani.",                data: result,            });        }),    };};