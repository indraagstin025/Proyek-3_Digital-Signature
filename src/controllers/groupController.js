import asyncHandler from "../utils/asyncHandler.js";import GroupError from "../errors/GroupError.js";/** * @description Helper untuk validasi dan konversi Group ID dari params. * @param {string} idParam - Parameter ID dari req.params * @returns {number} ID Grup sebagai integer. * @throws {GroupError.BadRequest} Jika format ID tidak valid. */const validateAndParseGroupId = (idParam) => {    const groupId = parseInt(idParam, 10);    if (isNaN(groupId)) {        throw GroupError.BadRequest("Format ID Grup tidak valid. Harap gunakan Angka.");    }    return groupId;};/** * Membuat objek controller untuk grup. * * @param {import('../services/groupService.js').GroupService} groupService - Instance dari GroupService. * @returns {object} - Kumpulan fungsi handler untuk routing grup. */export const createGroupController = (groupService) => {    return {        /**         * @description Membuat grup baru.         * @route POST /groups         */        createGroup: asyncHandler(async (req, res, next) => {            const { name } = req.body;            const adminId =req.user?.id;            const newGroup = await groupService.createGroup(adminId, name);            return res.status(201).json({                status: "success",                message: "Group berhasil diubah.",                data: newGroup,            });        }),        /**         * @description Mengambil semua grup di mana user terdaftar.         * @route GET /groups         */        getAllUserGroups: asyncHandler(async (req, res, next) => {            const userId = req.user?.id;            const groups = await groupService.getAllUserGroups(userId);            return res.status(200).json({                status: "success",                data: groups,            });        }),        /**         * @description Mengambil detail satu grup (jika user adalah anggota).         * @route GET /groups/:groupId         */        getGroupById: asyncHandler(async (req, res, next) => {            const groupId = validateAndParseGroupId(req.params.groupId); // Konversi ke Int            const userId = req.user?.id;            const group = await groupService.getGroupById(groupId, userId);            return res.status(200).json({                status: "success",                data: group,            });        }),        /**         * @description Membuat link undangan untuk grup.         * @route POST /groups/:groupId/invitations         */        createInvitation: asyncHandler(async (req, res, next) => {            const groupId = validateAndParseGroupId(req.params.groupId); // Konversi ke Int            const inviterId = req.user?.id;            const { role } = req.body;            if (!role) {                throw GroupError.BadRequest("Properti 'role' wajib diisi (cth: 'viewer').");            }            const invitation = await groupService.createInvitation(groupId, inviterId, role);            const frontendUrl = process.env.SITE_URL_URL || "http://localhost:5173";            const invitationLink = `${frontendUrl}/join?token=${invitation.token}`;            return res.status(201).json({                status: "success",                message: "Link undangan berhasil dibuat.",                data: {                    ...invitation,                    invitationLink: invitationLink                },            });        }),        /**         * @description Menerima undangan dan bergabung ke grup.         * @route POST /groups/invitations/accept         */        acceptInvitation: asyncHandler(async (req, res, next) => {            const { token } = req.body;            const userId = req.user?.id;            if (!token) {                throw GroupError.BadRequest("Token undangan wajib diisi.");            }            const newMember = await groupService.acceptInvitation(token, userId);            return res.status(201).json({                status: "success",                message: "Berhasil bergabung dengan grup.",                data: newMember,            });        }),        /**         * @description Menetapkan/memasukkan dokumen ke dalam grup.         * @route PUT /groups/:groupId/documents         */        assignDocumentToGroup: asyncHandler(async (req, res, next) => {            const groupId = validateAndParseGroupId(req.params.groupId); // Konversi ke Int            const userId = req.user?.id;            const { documentId } = req.body;            if (!documentId) {                throw GroupError.BadRequest("ProData 'documentId' wajib diisi.");            }            const updatedDocument = await groupService.assignDocumentToGroup(documentId, groupId, userId);            return res.status(200).json({                status: "success",                message: "Dokumen berhasil dimasukkan ke grup.",                data: updatedDocument,            });        }),        /**         * @description Mengeluarkan anggota dari grup (hanya admin).         * @route DELETE /groups/:groupId/members/:userIdToRemove         */        removeMember: asyncHandler(async (req, res, next) => {            const groupId = validateAndParseGroupId(req.params.groupId); // Konversi ke Int            const adminId = req.user?.id;            const { userIdToRemove } = req.params;            await groupService.removeMember(groupId, adminId, userIdToRemove);            return res.status(200).json({                status: "success",                message: "Anggota berhasil dikeluarkan dari grup.",            });        }),        // ... (setelah fungsi 'removeMember')        /**         * @description Mengubah nama grup.         * @route PUT /groups/:groupId         */        updateGroup: asyncHandler(async (req, res, next) => {            const groupId = validateAndParseGroupId(req.params.groupId);            const userId = req.user?.id;            const { name } = req.body;            if (!name) {                throw GroupError.BadRequest("Properti 'name' wajib diisi.");            }            const updatedGroup = await groupService.updateGroup(groupId, userId, name);            return res.status(200).json({                status: "success",                message: "Nama grup berhasil diperbarui.",                data: updatedGroup,            });        }),        /**         * @description Menghapus grup.         * @route DELETE /groups/:groupId         */        deleteGroup: asyncHandler(async (req, res, next) => {            const groupId = validateAndParseGroupId(req.params.groupId);            const userId = req.user?.id;            await groupService.deleteGroup(groupId, userId);            return res.status(200).json({                status: "success",                message: "Grup berhasil dihapus.",            });        }),        /**         * @description Melepaskan dokumen dari grup.         * @route DELETE /groups/:groupId/documents/:documentId         */        unassignDocumentFromGroup: asyncHandler(async (req, res, next) => {            const groupId = validateAndParseGroupId(req.params.groupId);            const { documentId } = req.params;            const userId = req.user?.id;            await groupService.unassignDocumentFromGroup(groupId, documentId, userId);            return res.status(200).json({                status: "success",                message: "Dokumen berhasil dilepaskan dari grup.",            });        }),    };};