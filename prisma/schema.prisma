generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DocumentStatus {
  draft
  pending
  completed
  archived

  @@map("document_status")
}

enum GroupMemberRole {
  admin_group
  signer
  viewer

  @@map("group_member_role")
}

enum SigningMethod {
  canvas
  qrcode

  @@map("signing_method")
}

enum InvitationStatus {
  active
  used
  expired
}

enum SignatureStatus {
  PENDING
  SIGNED
  REJECTED
}

enum AuditAction {
  CREATE_USER
  UPDATE_USER
  DELETE_USER
  FORCE_DELETE_DOCUMENT
  LOGIN
  LOGOUT
  UPDATE_GROUP
  SIGN_DOCUMENT_PERSONAL
  SIGN_DOCUMENT_GROUP
  SIGN_PACKAGE
  TRANSACTION_SUCCESS
  TRANSACTION_CANCELLED
  RESOLVE_USER_REPORT

  @@map("audit_action")
}

model User {
  id                 String                @id @db.Uuid
  phoneNumber        String?               @map("phone_number")
  email              String                @unique
  name               String
  title              String?
  company            String?
  address            String?
  isSuperAdmin       Boolean               @default(false) @map("is_super_admin")
  userStatus         String                @default("FREE") @map("user_status")
  premiumUntil       DateTime?             @map("premium_until")
  profilePictureUrl  String?               @map("profile_picture_url")
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  administeredGroups Group[]               @relation("AdminToGroup")
  documents          Document[]
  signaturesPersonal SignaturePersonal[]
  signaturesGroup    SignatureGroup[]      @relation("UserSignaturesGroup")
  groupMemberships   GroupMember[]
  profilePictures    UserProfilePicture[]
  sentInvitations    GroupInvitation[]     @relation("SentByInviter")
  uploadedVersions   DocumentVersion[]     @relation("UploadedBy")
  auditLogs          AuditLog[]            @relation("ActorAudit")
  tourProgress       Json?                 @default("{}") @map("tour_progress")
  signingPackages    SigningPackage[]
  packageSignatures  PackageSignature[]
  groupSigningTasks  GroupDocumentSigner[]
  apiRequestLogs     ApiRequestLog[]
  transactions       Transaction[]
  reports            UserReport[]

  @@map("users")
}

model UserReport {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String   @db.Text
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, RESOLVED, REJECTED
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("user_reports")
}

model UserProfilePicture {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  url       String
  hash      String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, hash], name: "user_picture_hash_unique")
  @@map("user_profile_pictures")
}

model Document {
  id            String         @id @default(uuid()) @db.Uuid
  title         String
  status        DocumentStatus @default(draft)
  signedFileUrl String?        @map("signed_file_url")
  type          String?        @default("General") @map("document_type")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  owner         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String         @map("user_id") @db.Uuid

  group   Group? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  groupId Int?   @map("group_id")

  versions         DocumentVersion[]
  currentVersion   DocumentVersion?      @relation("CurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)
  currentVersionId String?               @unique @map("current_version_id") @db.Uuid
  signerRequests   GroupDocumentSigner[]

  @@index([userId])
  @@index([groupId])
  @@index([status])
  @@index([userId, status])
  @@map("documents")
}

model DocumentVersion {
  id                String    @id @default(uuid()) @db.Uuid
  url               String    @db.Text
  hash              String?
  signedFileHash    String?   @unique @map("signed_file_hash")
  digitalSignature  String?   @map("digital_signature") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  document          Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId        String    @map("document_id") @db.Uuid
  documentAsCurrent Document? @relation("CurrentVersion")
  description       String?   @db.Text

  uploader User?   @relation("UploadedBy", fields: [userId], references: [id], onDelete: SetNull)
  userId   String? @map("user_id") @db.Uuid

  signaturesPersonal SignaturePersonal[]
  signaturesGroup    SignatureGroup[]
  packages           PackageDocument[]

  @@unique([documentId, hash], name: "document_version_hash_unique")
  @@index([documentId])
  @@map("document_versions")
}

model SignaturePersonal {
  id                String        @id @default(uuid()) @db.Uuid
  method            SigningMethod
  signatureImageUrl String        @map("signature_image_url")
  qrCodeDataUrl     String?       @map("qr_code_data_url")
  width             Float         @default(0) @map("width")
  height            Float         @default(0) @map("height")
  positionX         Float         @map("position_x")
  positionY         Float         @map("position_y")
  pageNumber        Int           @map("page_number")
  signedAt          DateTime      @default(now()) @map("signed_at")
  ipAddress         String?       @map("ip_address")
  userAgent         String?       @map("user_agent") @db.Text
  signerPublicKey   String?       @map("signer_public_key") @db.Text
  displayQrCode     Boolean       @default(true) @map("display_qr_code")

  // [BARU] Access Code untuk Verifikasi
  accessCode        String?         @map("access_code")
  retryCount        Int             @default(0) @map("retry_count")
  lockedUntil       DateTime?       @map("locked_until")
  status            String          @default("draft")
  documentVersionId String          @map("document_version_id") @db.Uuid
  documentVersion   DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)
  signerId          String          @map("signer_id") @db.Uuid
  signer            User            @relation(fields: [signerId], references: [id], onDelete: Cascade)
  signingBatchId    String?         @map("signing_batch_id") @db.Uuid

  @@index([signerId])
  @@index([documentVersionId])
  @@index([signerId, status])
  @@map("signatures_personal")
}

model SignatureGroup {
  id                String        @id @default(uuid()) @db.Uuid
  method            SigningMethod
  signatureImageUrl String        @map("signature_image_url")
  width             Float         @default(0) @map("width")
  height            Float         @default(0) @map("height")
  positionX         Float         @map("position_x")
  positionY         Float         @map("position_y")
  pageNumber        Int           @map("page_number")
  signedAt          DateTime      @default(now()) @map("signed_at")
  ipAddress         String?       @map("ip_address")
  userAgent         String?       @map("user_agent") @db.Text

  // [BARU] Access Code untuk Verifikasi
  accessCode  String?   @map("access_code")
  retryCount  Int       @default(0) @map("retry_count")
  lockedUntil DateTime? @map("locked_until")

  status            String               @default("draft")
  documentVersionId String               @map("document_version_id") @db.Uuid
  documentVersion   DocumentVersion      @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)
  signerId          String               @map("signer_id") @db.Uuid
  signer            User                 @relation("UserSignaturesGroup", fields: [signerId], references: [id], onDelete: Cascade)
  requestData       GroupDocumentSigner?

  @@index([signerId])
  @@index([documentVersionId])
  @@index([signerId, status])
  @@map("signatures_group")
}

model SigningPackage {
  id        String            @id @default(uuid()) @db.Uuid
  title     String?
  status    String            @default("draft")
  createdAt DateTime          @default(now())
  userId    String            @map("user_id") @db.Uuid
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents PackageDocument[]

  @@index([userId])
  @@map("signing_packages")
}

model PackageDocument {
  id           String             @id @default(uuid()) @db.Uuid
  packageId    String             @map("package_id") @db.Uuid
  package      SigningPackage     @relation(fields: [packageId], references: [id], onDelete: Cascade)
  docVersionId String             @map("doc_version_id") @db.Uuid
  docVersion   DocumentVersion    @relation(fields: [docVersionId], references: [id], onDelete: Cascade)
  order        Int
  signatures   PackageSignature[]

  @@index([packageId])
  @@index([docVersionId])
  @@map("package_documents")
}

model PackageSignature {
  id                String          @id @default(uuid()) @db.Uuid
  packageDocumentId String          @map("package_document_id") @db.Uuid
  packageDocument   PackageDocument @relation(fields: [packageDocumentId], references: [id], onDelete: Cascade)
  signatureImageUrl String          @map("signature_image_url") @db.Text
  pageNumber        Int             @map("page_number")
  positionX         Float
  positionY         Float
  width             Float
  height            Float
  signerId          String          @map("signer_id") @db.Uuid
  signer            User            @relation(fields: [signerId], references: [id], onDelete: Cascade)
  status            String          @default("draft")
  createdAt         DateTime        @default(now()) @map("created_at")
  ipAddress         String?         @map("ip_address")
  userAgent         String?         @map("user_agent")

  // [BARU] Access Code untuk Verifikasi
  accessCode  String?   @map("access_code")
  retryCount  Int       @default(0) @map("retry_count")
  lockedUntil DateTime? @map("locked_until")

  @@index([signerId])
  @@index([packageDocumentId])
  @@map("package_signatures")
}

model Group {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  admin     User     @relation("AdminToGroup", fields: [adminId], references: [id], onDelete: Restrict)
  adminId   String   @map("admin_id") @db.Uuid

  members     GroupMember[]
  documents   Document[]
  invitations GroupInvitation[]

  @@index([adminId])
  @@map("groups")
}

model GroupMember {
  id        Int             @id @default(autoincrement())
  role      GroupMemberRole @default(viewer)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  group     Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId   Int             @map("group_id")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id") @db.Uuid

  @@index([groupId])
  @@index([userId])
  @@index([groupId, userId])
  @@map("group_members")
}

model GroupInvitation {
  id         Int              @id @default(autoincrement())
  email      String?
  token      String           @unique
  role       GroupMemberRole
  status     InvitationStatus @default(active)
  usageLimit Int?             @map("usage_limit")
  expiresAt  DateTime         @map("expires_at")
  inviterId  String           @map("inviter_id") @db.Uuid
  inviter    User             @relation("SentByInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")
  group      Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId    Int              @map("group_id")

  @@index([groupId])
  @@index([inviterId])
  @@map("group_invitations")
}

model GroupDocumentSigner {
  id               String          @id @default(uuid()) @db.Uuid
  status           SignatureStatus @default(PENDING)
  order            Int             @default(1)
  documentId       String          @map("document_id") @db.Uuid
  document         Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId           String          @map("user_id") @db.Uuid
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  signatureGroupId String?         @unique @map("signature_group_id") @db.Uuid
  signatureGroup   SignatureGroup? @relation(fields: [signatureGroupId], references: [id])
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  @@unique([documentId, userId], name: "unique_signer_per_document")
  @@index([userId])
  @@index([documentId])
  @@index([status])
  @@index([userId, status])
  @@map("group_document_signers")
}

model Transaction {
  id        String   @id @default(uuid()) @db.Uuid
  orderId   String   @unique @map("order_id")
  amount    Float
  status    String   @default("PENDING")
  planType  String   @map("plan_type")
  snapToken String?  @map("snap_token")
  snapUrl   String?  @map("snap_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("transactions")
}

model AuditLog {
  id          String      @id @default(uuid()) @db.Uuid
  action      AuditAction
  description String?     @db.Text
  actorId     String      @map("actor_id") @db.Uuid
  actor       User        @relation("ActorAudit", fields: [actorId], references: [id], onDelete: Cascade)
  targetId    String?     @map("target_id")
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  createdAt   DateTime    @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([actorId])
  @@map("audit_logs")
}

model ApiRequestLog {
  id         String   @id @default(uuid()) @db.Uuid
  method     String
  endpoint   String
  statusCode Int
  duration   Int
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  userId String? @map("user_id") @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([userId])
  @@map("api_request_logs")
}
