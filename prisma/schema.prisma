

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DocumentStatus {
  draft
  pending
  completed
  archived
  @@map("document_status")
}

enum GroupMemberRole {
  admin_group
  signer
  viewer
  @@map("group_member_role")
}

enum SigningMethod {
  canvas
  qrcode
  @@map("signing_method")
}

enum InvitationStatus {
  active
  used
  expired
}

enum SignatureStatus {
  PENDING
  SIGNED
  REJECTED
}

// --- Model ---

model User {
  id                 String              @id @db.Uuid
  phoneNumber        String?             @map("phone_number")
  email              String              @unique
  name               String
  title              String?
  company            String?
  address            String?
  isSuperAdmin       Boolean             @default(false) @map("is_super_admin")
  profilePictureUrl  String?             @map("profile_picture_url")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  administeredGroups Group[]             @relation("AdminToGroup")
  documents          Document[]
  signaturesPersonal SignaturePersonal[]
  signaturesGroup    SignatureGroup[]    @relation("UserSignaturesGroup")
  groupMemberships   GroupMember[]
  profilePictures    UserProfilePicture[]
  sentInvitations    GroupInvitation[]   @relation("SentByInviter")
  uploadedVersions   DocumentVersion[]   @relation("UploadedBy")

  // --- TAMBAHAN UNTUK PAKET (ALUR WIZARD) ---
  signingPackages   SigningPackage[]    // Paket yang dibuat oleh User ini
  packageSignatures PackageSignature[]  // TTD yang ditempatkan oleh User ini
  // --- AKHIR TAMBAHAN ---

  @@map("users")
}

model UserProfilePicture {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  url       String
  hash      String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, hash], name: "user_picture_hash_unique")
  @@map("user_profile_pictures")
}


model Document {
  id               String           @id @default(uuid()) @db.Uuid
  title            String
  status           DocumentStatus   @default(draft)
  signedFileUrl    String?          @map("signed_file_url")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  owner            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String           @map("user_id") @db.Uuid

  // (Tidak diubah, sesuai permintaan Anda agar fitur tetap aman)
  group            Group?           @relation(fields: [groupId], references: [id], onDelete: SetNull)
  groupId          Int?             @map("group_id")

  versions         DocumentVersion[]
  currentVersion   DocumentVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)
  currentVersionId String?          @unique @map("current_version_id") @db.Uuid
  @@map("documents")
}

model DocumentVersion {
  id                 String              @id @default(uuid()) @db.Uuid
  url                String              @db.Text
  hash               String?
  signedFileHash     String?             @unique @map("signed_file_hash")
  digitalSignature   String?             @map("digital_signature") @db.Text
  createdAt          DateTime            @default(now()) @map("created_at")
  document           Document            @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId         String              @map("document_id") @db.Uuid
  documentAsCurrent  Document?           @relation("CurrentVersion")

  // ✅ [PERBAIKAN 1] Relasi uploader ditambahkan
  //    (dibuat opsional '?' & onDelete: SetNull agar user bisa dihapus tanpa menghapus versi)
  uploader           User?               @relation("UploadedBy", fields: [userId], references: [id], onDelete: SetNull)
  userId             String?             @map("user_id") @db.Uuid // ✅ [PERBAIKAN 2] Dibuat opsional (?)

  signaturesPersonal SignaturePersonal[]
  signaturesGroup    SignatureGroup[]
  packages           PackageDocument[]

  // ✅ [PERBAIKAN 3] Aturan unik diubah agar lebih logis
  @@unique([documentId, hash], name: "document_version_hash_unique")
  @@map("document_versions")
}

model SignaturePersonal {
  id                String          @id @default(uuid()) @db.Uuid
  method            SigningMethod
  signatureImageUrl String          @map("signature_image_url")
  qrCodeDataUrl     String?         @map("qr_code_data_url")
  width             Float           @map("width")    @default(0)
  height            Float           @map("height")   @default(0)
  positionX         Float           @map("position_x")
  positionY         Float           @map("position_y")
  pageNumber        Int             @map("page_number")
  signedAt          DateTime        @default(now()) @map("signed_at")
  ipAddress         String?         @map("ip_address")
  userAgent         String?         @map("user_agent") @db.Text
  signerPublicKey   String?         @map("signer_public_key") @db.Text
  displayQrCode     Boolean         @default(true) @map("display_qr_code")
  documentVersionId String          @map("document_version_id") @db.Uuid
  documentVersion   DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)
  signerId          String          @map("signer_id") @db.Uuid
  signer            User            @relation(fields: [signerId], references: [id], onDelete: Cascade)
  signingBatchId    String?         @map("signing_batch_id") @db.Uuid
  @@map("signatures_personal")
}



model SignatureGroup {
  id                 String          @id @default(uuid()) @db.Uuid
  method             SigningMethod
  signatureImageUrl  String          @map("signature_image_url")
  width              Float           @map("width")    @default(0)
  height             Float           @map("height")   @default(0)
  positionX          Float           @map("position_x")
  positionY          Float           @map("position_y")
  pageNumber         Int             @map("page_number")
  signedAt           DateTime        @default(now()) @map("signed_at")
  ipAddress          String?         @map("ip_address")
  userAgent          String?         @map("user_agent") @db.Text
  documentVersionId  String          @map("document_version_id") @db.Uuid
  documentVersion    DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)
  signerId           String          @map("signer_id") @db.Uuid
  signer             User            @relation("UserSignaturesGroup", fields: [signerId], references: [id], onDelete: Cascade)
  @@map("signatures_group")
}


// --- MODEL UNTUK ALUR WIZARD BATCH SIGNING (PAKET) ---

// 1. MODEL "AMPLOP" ATAU "PAKET" UTAMA
// Ini adalah wadah untuk seluruh sesi batch signing.
model SigningPackage {
  id        String   @id @default(uuid()) @db.Uuid
  title     String?  // Misal: "Kontrak Klien Q4"
  status    String   @default("draft") // draft, pending, completed
  createdAt DateTime @default(now())

  // Siapa yang membuat paket ini
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dokumen apa saja yang ada di dalam paket ini
  // (Relasi balik ke PackageDocument)
  documents PackageDocument[]

  @@map("signing_packages")
}


// 2. MODEL PERANTARA (DOKUMEN DI DALAM PAKET)
// Ini menghubungkan Paket dengan Versi Dokumen yang spesifik.
model PackageDocument {
  id          String   @id @default(uuid()) @db.Uuid

  // Terhubung ke Paket mana
  packageId   String         @map("package_id") @db.Uuid
  package     SigningPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  // Menunjuk ke VERSI DOKUMEN ASLI (yang akan ditandatangani)
  docVersionId String          @map("doc_version_id") @db.Uuid
  docVersion   DocumentVersion @relation(fields: [docVersionId], references: [id], onDelete: Cascade)

  order       Int // Urutan dokumen (Dokumen 1, Dokumen 2, dst.)

  // Tanda tangan yang ditempatkan di DOKUMEN SPESIFIK INI
  // (Relasi balik ke PackageSignature)
  signatures  PackageSignature[]

  @@map("package_documents")
}

// 3. MODEL TANDA TANGAN (SPESIFIK UNTUK PAKET)
// Menyimpan data TTD (posisi, gambar) untuk setiap dokumen dalam paket.
model PackageSignature {
  id        String   @id @default(uuid()) @db.Uuid

  // Terhubung ke Dokumen Paket mana
  packageDocumentId String          @map("package_document_id") @db.Uuid
  packageDocument   PackageDocument @relation(fields: [packageDocumentId], references: [id], onDelete: Cascade)

  // Data Tanda Tangan (posisi, dll.)
  // Gunakan @db.Text agar muat untuk base64 yang panjang
  signatureImageUrl String  @map("signature_image_url") @db.Text
  pageNumber        Int     @map("page_number")
  positionX         Float
  positionY         Float
  width             Float
  height            Float

  // Data Penanda Tangan
  signerId          String  @map("signer_id") @db.Uuid
  signer            User    @relation(fields: [signerId], references: [id], onDelete: Cascade)

  @@map("package_signatures")
}

// --- AKHIR MODEL UNTUK ALUR WIZARD ---
model Group {
  id            Int               @id @default(autoincrement())
  name          String
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  // ✅ [PERBAIKAN KRITIS] Dijaga agar tetap 'Restrict'
  admin         User              @relation("AdminToGroup", fields: [adminId], references: [id], onDelete: Restrict)
  adminId       String            @map("admin_id") @db.Uuid

  members       GroupMember[]
  documents     Document[]
  invitations   GroupInvitation[]
  @@map("groups")
}

model GroupMember {
  id        Int             @id @default(autoincrement())
  role      GroupMemberRole @default(viewer)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  group     Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // (Tidak diubah, sesuai permintaan Anda)
  groupId   Int             @map("group_id")

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String          @map("user_id") @db.Uuid
  @@map("group_members")
}

model GroupInvitation {
  id         Int              @id @default(autoincrement())
  email      String?
  token      String           @unique
  role       GroupMemberRole
  status     InvitationStatus @default(active)
  usageLimit Int?             @map("usage_limit")
  expiresAt  DateTime         @map("expires_at")
  inviterId  String           @map("inviter_id") @db.Uuid
  inviter    User             @relation("SentByInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")
  group      Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // (Tidak diuhbah, sesuai permintaan Anda)
  groupId    Int              @map("group_id")

  @@map("group_invitations")
}